{% extends "base.html" %}
{% block content %}

<a href="{{ url_for('buy_sell') }}" class="back-link">â† Back to Buy & Sell</a>

<div class="product-detail-flex">

    <!-- LEFT SECTION -->
    <div class="left-section">
        {% if item.image %}
            <img src="{{ url_for('static', filename='uploads/' ~ item.image) }}"
                 alt="{{ item.name }}" class="product-main-image">
        {% else %}
            <div class="product-main-image"
                 style="display:flex;align-items:center;justify-content:center;background:#e3f2fd;">
                No Image
            </div>
        {% endif %}
    </div>

    <!-- RIGHT SECTION -->
    <div class="right-section">

        {% if session['user_id'] == item.user_id or session['role'] == 'admin' %}
        <div class="edit-delete-buttons">
            {% if item.status != 'sold' %}
            <a href="{{ url_for('mark_sold', item_id=item.id) }}" class="sold-btn"
               onclick="return confirm('Mark this item as sold?');">âœ” Sold Out</a>
            {% endif %}

            <a href="{{ url_for('edit_product', item_id=item.id) }}" class="edit-btn">âœï¸ Edit</a>

            <a href="{{ url_for('delete_product', item_id=item.id) }}" class="delete-btn"
               onclick="return confirm('Delete this item?');">ğŸ—‘ Delete</a>
        </div>
        {% endif %}

        <!-- PRODUCT NAME -->
        <h4 class="product-title-heading">Product Name</h4>
        <h1 class="product-title">{{ item.name }}</h1>

        <!-- PRICE -->
        <h4 class="product-title-heading">Price</h4>
        <p class="product-price-large">â‚¹{{ item.price }}</p>

        <!-- BUY BUTTON (ONLY FOR BUYERS) -->
        {% if item.status == 'available'
              and 'user_id' in session
              and session['user_id'] != item.user_id %}
        <div class="info-card" style="margin-top:20px;">
            <form action="{{ url_for('create_order', item_id=item.id) }}" method="POST">
                <button type="submit" class="sold-btn"
                        style="width:100%;font-size:18px;padding:12px;">
                    ğŸ’³ Buy Now (via Razorpay)
                </button>
            </form>
        </div>
        {% endif %}

        <!-- CHAT BUTTON -->
        <button id="openChatBtn"
            data-chat-url="{{ url_for('chat_page', chat_type='buy', item_id=item.id) }}"
            data-return-url="{{ request.path }}"
            class="chat-open-main-btn">
            <i class="fa-solid fa-comment"></i> Chat
        </button>

        <!-- DESCRIPTION -->
        <div class="info-card">
            <h4 class="product-title-heading">Description</h4>
            <p class="info-text">{{ item.description }}</p>
        </div>

        <!-- SELLER INFO -->
        <div class="info-card">
            <h4 class="product-title-heading">Seller Information</h4>
            <div class="seller-grid">
                <p><strong>Name:</strong> {{ item.seller_name }}</p>
                <p><strong>Roll Number:</strong> {{ item.roll_number }}</p>
                <p><strong>Contact:</strong> {{ item.contact }}</p>
                <p><strong>Email:</strong> {{ item.email }}</p>
                <p><strong>Pickup Place:</strong> {{ item.pickup_place }}</p>
                <p><strong>Posted On:</strong> {{ item.created_at }}</p>
            </div>
        </div>
    </div>
</div>


<!-- CHAT OVERLAY -->
<div id="chatOverlay" class="chat-overlay {% if chat_open %}open{% endif %}">
    <div class="chat-modal">

        <button type="button" class="chat-close-btn" id="chatCloseBtn">&times;</button>

        <div class="chat-header">
            <div class="chat-item-title">
                {{ item.name if chat_type == "buy" else item.item }}
            </div>

            {% if current_chat_partner %}
            <div class="chat-partner-name">
                @{{ current_chat_partner.username }}
            </div>
            {% endif %}
        </div>

        <div class="chat-body-wrapper"
             id="chatWrapper"
             data-chat-type="{{ chat_type }}"
             data-chat-id="{{ item.id }}"
             data-partner-id="{% if current_chat_partner %}{{ current_chat_partner.id }}{% endif %}">

            {% if chat_buyers and session['user_id'] == item.user_id %}
            <div class="chat-sidebar">
                <div class="chat-sidebar-title">Conversations</div>
                {% for buyer in chat_buyers %}
                <a href="{{ url_for('chat_page', chat_type=chat_type, item_id=item.id, chat_with=buyer.id) }}"
                   class="chat-sidebar-user {% if current_chat_partner and buyer.id == current_chat_partner.id %}active{% endif %}">
                    <span class="chat-avatar-circle">{{ buyer.username[0]|upper }}</span>
                    <span class="chat-sidebar-username">{{ buyer.username }}</span>
                </a>
                {% endfor %}
            </div>
            {% endif %}

            <div class="chat-main">

                <div class="chat-messages" id="chatMessages">
                    {% for m in chat_messages %}
                    <div class="chat-message-row {% if m.sender_id == session['user_id'] %}from-me{% else %}from-them{% endif %}">
                        <div class="chat-bubble">
                            <div class="chat-bubble-text">{{ m.message }}</div>
                            <div class="chat-bubble-meta">{{ m.created_at }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <form id="chatForm"
                      class="chat-input-form"
                      method="post"
                      action="{{ url_for('send_chat_message', chat_type=chat_type, item_id=item.id) }}">

                    {% if current_chat_partner %}
                    <input type="hidden" name="other_user_id" value="{{ current_chat_partner.id }}">
                    {% endif %}

                    <textarea name="message"
                              rows="1"
                              placeholder="Type your message..."
                              class="chat-message-input"
                              required></textarea>

                    <button type="submit" class="chat-send-btn">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>

                </form>

            </div>
        </div>
    </div>
</div>

{% endblock %}
